<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - TechMobile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="font-sans bg-gray-50">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4 py-6">
                <div class="flex justify-between items-center">
                    <h1 class="text-3xl font-bold text-gray-900">TechMobile Admin</h1>
                    <a href="index.html" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">
                        <i class="fas fa-home mr-2"></i>
                        Back to Store
                    </a>
                </div>
            </div>
        </header>

        <div class="max-w-7xl mx-auto px-4 py-8">
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                            <i class="fas fa-box text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Total Products</p>
                            <p id="total-products" class="text-2xl font-semibold text-gray-900">-</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-green-100 text-green-600">
                            <i class="fas fa-shopping-cart text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Total Orders</p>
                            <p id="total-orders" class="text-2xl font-semibold text-gray-900">-</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                            <i class="fas fa-dollar-sign text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Total Revenue</p>
                            <p id="total-revenue" class="text-2xl font-semibold text-gray-900">-</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                            <i class="fas fa-users text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Active Carts</p>
                            <p id="active-carts" class="text-2xl font-semibold text-gray-900">-</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="bg-white rounded-lg shadow">
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-8 px-6">
                        <button onclick="showTab('products')" class="tab-button active py-4 px-1 border-b-2 border-indigo-500 font-medium text-sm text-indigo-600">
                            Products
                        </button>
                        <button onclick="showTab('orders')" class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700">
                            Orders
                        </button>
                        <button onclick="showTab('inventory')" class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700">
                            Inventory
                        </button>
                    </nav>
                </div>

                <!-- Products Tab -->
                <div id="products-tab" class="tab-content p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-semibold">Products Management</h2>
                        <button onclick="showAddProductForm()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">
                            <i class="fas fa-plus mr-2"></i>
                            Add Product
                        </button>
                    </div>

                    <!-- Add Product Form (Hidden by default) -->
                    <div id="add-product-form" class="hidden bg-gray-50 rounded-lg p-6 mb-6">
                        <h3 class="text-lg font-semibold mb-4">Add New Product</h3>
                        <form class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Product Name</label>
                                <input type="text" id="product-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-600 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Price</label>
                                <input type="number" id="product-price" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-600 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                                <select id="product-category" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-600 focus:border-transparent">
                                    <option value="iphones">iPhones</option>
                                    <option value="android">Android</option>
                                    <option value="tablets">Tablets</option>
                                    <option value="accessories">Accessories</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Stock Quantity</label>
                                <input type="number" id="product-stock" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-600 focus:border-transparent">
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                                <textarea id="product-description" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-600 focus:border-transparent"></textarea>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Image URL</label>
                                <input type="url" id="product-image" placeholder="/placeholder.svg?height=300&width=300" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-600 focus:border-transparent">
                            </div>
                            <div class="md:col-span-2 flex gap-4">
                                <button type="button" onclick="addProduct()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                                    <i class="fas fa-save mr-2"></i>
                                    Save Product
                                </button>
                                <button type="button" onclick="hideAddProductForm()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Products List -->
                    <div id="products-list" class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stock</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="products-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Products will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Orders Tab -->
                <div id="orders-tab" class="tab-content hidden p-6">
                    <h2 class="text-xl font-semibold mb-6">Recent Orders</h2>
                    <div id="orders-list" class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Order ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="orders-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Orders will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Inventory Tab -->
                <div id="inventory-tab" class="tab-content hidden p-6">
                    <h2 class="text-xl font-semibold mb-6">Inventory Management</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <h3 class="text-lg font-semibold text-red-800 mb-2">Low Stock Alert</h3>
                            <div id="low-stock-items">
                                <!-- Low stock items will be loaded here -->
                            </div>
                        </div>
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <h3 class="text-lg font-semibold text-yellow-800 mb-2">Out of Stock</h3>
                            <div id="out-of-stock-items">
                                <!-- Out of stock items will be loaded here -->
                            </div>
                        </div>
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <h3 class="text-lg font-semibold text-green-800 mb-2">Well Stocked</h3>
                            <div id="well-stocked-items">
                                <!-- Well stocked items will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { supabase, productsAPI, ordersAPI } from './lib/supabase.js';

        // Load dashboard data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardStats();
            loadProducts();
        });

        async function loadDashboardStats() {
            try {
                // Load products count
                const products = await productsAPI.getAll();
                document.getElementById('total-products').textContent = products.length;

                // Load orders
                const orders = await ordersAPI.getOrders();
                document.getElementById('total-orders').textContent = orders.length;

                // Calculate revenue
                const totalRevenue = orders.reduce((sum, order) => sum + parseFloat(order.total_amount), 0);
                document.getElementById('total-revenue').textContent = `$${totalRevenue.toFixed(2)}`;

                // Load active carts count
                const { data: cartItems } = await supabase.from('cart_items').select('session_id, user_id');
                const uniqueCarts = new Set();
                cartItems?.forEach(item => {
                    if (item.user_id) uniqueCarts.add(item.user_id);
                    if (item.session_id) uniqueCarts.add(item.session_id);
                });
                document.getElementById('active-carts').textContent = uniqueCarts.size;

            } catch (error) {
                console.error('Error loading dashboard stats:', error);
            }
        }

        async function loadProducts() {
            try {
                const products = await productsAPI.getAll();
                const tbody = document.getElementById('products-table-body');
                
                tbody.innerHTML = products.map(product => `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <img class="h-10 w-10 rounded-full object-cover" src="${product.image_url}" alt="${product.name}">
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900">${product.name}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                                ${product.category}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            $${product.price.toFixed(2)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                                product.stock_quantity <= 5 ? 'bg-red-100 text-red-800' : 
                                product.stock_quantity <= 10 ? 'bg-yellow-100 text-yellow-800' : 
                                'bg-green-100 text-green-800'
                            }">
                                ${product.stock_quantity}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="editProduct('${product.id}')" class="text-indigo-600 hover:text-indigo-900 mr-4">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteProduct('${product.id}')" class="text-red-600 hover:text-red-900">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');

                // Load inventory data
                loadInventoryData(products);
                
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }

        async function loadOrders() {
            try {
                const orders = await ordersAPI.getOrders();
                const tbody = document.getElementById('orders-table-body');
                
                tbody.innerHTML = orders.map(order => `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                            ${order.id.substring(0, 8)}...
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${new Date(order.created_at).toLocaleDateString()}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            $${parseFloat(order.total_amount).toFixed(2)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                                order.status === 'completed' ? 'bg-green-100 text-green-800' :
                                order.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                                'bg-gray-100 text-gray-800'
                            }">
                                ${order.status}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="viewOrder('${order.id}')" class="text-indigo-600 hover:text-indigo-900">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
                
            } catch (error) {
                console.error('Error loading orders:', error);
            }
        }

        function loadInventoryData(products) {
            const lowStock = products.filter(p => p.stock_quantity <= 5 && p.stock_quantity > 0);
            const outOfStock = products.filter(p => p.stock_quantity === 0);
            const wellStocked = products.filter(p => p.stock_quantity > 10);

            document.getElementById('low-stock-items').innerHTML = lowStock.length > 0 ? 
                lowStock.map(p => `<p class="text-sm text-red-700">${p.name} (${p.stock_quantity})</p>`).join('') :
                '<p class="text-sm text-gray-500">No low stock items</p>';

            document.getElementById('out-of-stock-items').innerHTML = outOfStock.length > 0 ?
                outOfStock.map(p => `<p class="text-sm text-yellow-700">${p.name}</p>`).join('') :
                '<p class="text-sm text-gray-500">No out of stock items</p>';

            document.getElementById('well-stocked-items').innerHTML = wellStocked.length > 0 ?
                `<p class="text-sm text-green-700">${wellStocked.length} products well stocked</p>` :
                '<p class="text-sm text-gray-500">No well stocked items</p>';
        }

        async function addProduct() {
            try {
                const name = document.getElementById('product-name').value;
                const price = parseFloat(document.getElementById('product-price').value);
                const category = document.getElementById('product-category').value;
                const stock = parseInt(document.getElementById('product-stock').value);
                const description = document.getElementById('product-description').value;
                const imageUrl = document.getElementById('product-image').value || '/placeholder.svg?height=300&width=300';

                if (!name || !price || !stock) {
                    alert('Please fill in all required fields');
                    return;
                }

                const { data, error } = await supabase.from('products').insert({
                    name,
                    price,
                    category,
                    stock_quantity: stock,
                    description,
                    image_url: imageUrl
                });

                if (error) throw error;

                alert('Product added successfully!');
                hideAddProductForm();
                loadProducts();
                loadDashboardStats();

            } catch (error) {
                console.error('Error adding product:', error);
                alert('Error adding product: ' + error.message);
            }
        }

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('border-indigo-500', 'text-indigo-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.remove('hidden');
            
            // Add active class to selected button
            event.target.classList.add('border-indigo-500', 'text-indigo-600');
            event.target.classList.remove('border-transparent', 'text-gray-500');

            // Load data for specific tabs
            if (tabName === 'orders') {
                loadOrders();
            }
        }

        function showAddProductForm() {
            document.getElementById('add-product-form').classList.remove('hidden');
        }

        function hideAddProductForm() {
            document.getElementById('add-product-form').classList.add('hidden');
            // Clear form
            document.getElementById('product-name').value = '';
            document.getElementById('product-price').value = '';
            document.getElementById('product-stock').value = '';
            document.getElementById('product-description').value = '';
            document.getElementById('product-image').value = '';
        }

        async function deleteProduct(productId) {
            if (!confirm('Are you sure you want to delete this product?')) {
                return;
            }

            try {
                const { error } = await supabase.from('products').delete().eq('id', productId);
                
                if (error) throw error;

                alert('Product deleted successfully!');
                loadProducts();
                loadDashboardStats();

            } catch (error) {
                console.error('Error deleting product:', error);
                alert('Error deleting product: ' + error.message);
            }
        }

        function editProduct(productId) {
            alert('Edit functionality would be implemented here');
        }

        function viewOrder(orderId) {
            alert(`View order details for: ${orderId}`);
        }

        // Make functions available globally
        window.showTab = showTab;
        window.showAddProductForm = showAddProductForm;
        window.hideAddProductForm = hideAddProductForm;
        window.addProduct = addProduct;
        window.deleteProduct = deleteProduct;
        window.editProduct = editProduct;
        window.viewOrder = viewOrder;
    </script>
</body>
</html>

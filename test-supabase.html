<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Supabase Integration - TechMobile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="font-sans bg-gray-50">
    <div class="max-w-4xl mx-auto px-4 py-12">
        <div class="bg-white rounded-lg shadow-lg p-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-8">Supabase Integration Test</h1>
            
            <!-- Connection Status -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold mb-4">Connection Status</h2>
                <div id="connection-status" class="p-4 rounded-lg">
                    <i class="fas fa-spinner fa-spin mr-2"></i>
                    Testing connection...
                </div>
            </div>

            <!-- Products Test -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold mb-4">Products Database</h2>
                <button onclick="testProducts()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 mb-4">
                    <i class="fas fa-database mr-2"></i>
                    Load Products
                </button>
                <div id="products-result" class="bg-gray-100 p-4 rounded-lg min-h-[100px]">
                    Click "Load Products" to test database connection
                </div>
            </div>

            <!-- Cart Test -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold mb-4">Cart Functionality</h2>
                <div class="flex gap-4 mb-4">
                    <button onclick="testAddToCart()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                        <i class="fas fa-cart-plus mr-2"></i>
                        Add Test Item
                    </button>
                    <button onclick="testGetCart()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">
                        <i class="fas fa-shopping-cart mr-2"></i>
                        Get Cart Items
                    </button>
                    <button onclick="testClearCart()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">
                        <i class="fas fa-trash mr-2"></i>
                        Clear Cart
                    </button>
                </div>
                <div id="cart-result" class="bg-gray-100 p-4 rounded-lg min-h-[100px]">
                    Test cart functionality using the buttons above
                </div>
            </div>

            <!-- Order Test -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold mb-4">Order Processing</h2>
                <button onclick="testCreateOrder()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 mb-4">
                    <i class="fas fa-receipt mr-2"></i>
                    Create Test Order
                </button>
                <div id="order-result" class="bg-gray-100 p-4 rounded-lg min-h-[100px]">
                    Click "Create Test Order" to test order processing
                </div>
            </div>

            <!-- Navigation -->
            <div class="border-t pt-8">
                <h2 class="text-xl font-semibold mb-4">Navigation</h2>
                <div class="flex flex-wrap gap-4">
                    <a href="index.html" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">
                        <i class="fas fa-home mr-2"></i>
                        Home
                    </a>
                    <a href="products-dynamic.html" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                        <i class="fas fa-box mr-2"></i>
                        Dynamic Products
                    </a>
                    <a href="checkout.html" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                        <i class="fas fa-credit-card mr-2"></i>
                        Checkout
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { supabase, productsAPI, cartAPI, ordersAPI } from './lib/supabase.js';

        // Test connection on page load
        document.addEventListener('DOMContentLoaded', testConnection);

        async function testConnection() {
            const statusDiv = document.getElementById('connection-status');
            
            try {
                // Test basic connection
                const { data, error } = await supabase.from('products').select('count', { count: 'exact', head: true });
                
                if (error) {
                    throw error;
                }
                
                statusDiv.innerHTML = `
                    <div class="flex items-center text-green-600">
                        <i class="fas fa-check-circle mr-2"></i>
                        <span>✅ Connected to Supabase successfully!</span>
                    </div>
                    <p class="text-sm text-gray-600 mt-2">Found ${data || 0} products in database</p>
                `;
                statusDiv.className = 'p-4 rounded-lg bg-green-50 border border-green-200';
                
            } catch (error) {
                console.error('Connection error:', error);
                statusDiv.innerHTML = `
                    <div class="flex items-center text-red-600">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        <span>❌ Connection failed</span>
                    </div>
                    <p class="text-sm text-gray-600 mt-2">Error: ${error.message}</p>
                    <p class="text-sm text-gray-600 mt-1">Please check your Supabase configuration in lib/supabase.js</p>
                `;
                statusDiv.className = 'p-4 rounded-lg bg-red-50 border border-red-200';
            }
        }

        async function testProducts() {
            const resultDiv = document.getElementById('products-result');
            resultDiv.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Loading products...';
            
            try {
                const products = await productsAPI.getAll();
                
                if (products.length === 0) {
                    resultDiv.innerHTML = `
                        <div class="text-yellow-600">
                            <i class="fas fa-exclamation-triangle mr-2"></i>
                            No products found. Make sure you ran the seed script.
                        </div>
                    `;
                    return;
                }
                
                resultDiv.innerHTML = `
                    <div class="text-green-600 mb-4">
                        <i class="fas fa-check mr-2"></i>
                        Successfully loaded ${products.length} products
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${products.slice(0, 4).map(product => `
                            <div class="border rounded-lg p-4">
                                <h3 class="font-semibold">${product.name}</h3>
                                <p class="text-gray-600">$${product.price}</p>
                                <p class="text-sm text-gray-500">${product.category}</p>
                            </div>
                        `).join('')}
                    </div>
                    ${products.length > 4 ? `<p class="text-sm text-gray-500 mt-4">... and ${products.length - 4} more products</p>` : ''}
                `;
                
            } catch (error) {
                console.error('Products test error:', error);
                resultDiv.innerHTML = `
                    <div class="text-red-600">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        Error loading products: ${error.message}
                    </div>
                `;
            }
        }

        async function testAddToCart() {
            const resultDiv = document.getElementById('cart-result');
            resultDiv.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Adding item to cart...';
            
            try {
                // Get first product to add to cart
                const products = await productsAPI.getAll();
                if (products.length === 0) {
                    throw new Error('No products available to add to cart');
                }
                
                const firstProduct = products[0];
                await cartAPI.addItem(firstProduct.id, 1);
                
                resultDiv.innerHTML = `
                    <div class="text-green-600">
                        <i class="fas fa-check mr-2"></i>
                        Successfully added "${firstProduct.name}" to cart!
                    </div>
                `;
                
            } catch (error) {
                console.error('Add to cart error:', error);
                resultDiv.innerHTML = `
                    <div class="text-red-600">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        Error adding to cart: ${error.message}
                    </div>
                `;
            }
        }

        async function testGetCart() {
            const resultDiv = document.getElementById('cart-result');
            resultDiv.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Loading cart items...';
            
            try {
                const cartItems = await cartAPI.getItems();
                
                if (cartItems.length === 0) {
                    resultDiv.innerHTML = `
                        <div class="text-gray-600">
                            <i class="fas fa-shopping-cart mr-2"></i>
                            Cart is empty. Try adding an item first.
                        </div>
                    `;
                    return;
                }
                
                const totalItems = cartItems.reduce((sum, item) => sum + item.quantity, 0);
                const totalValue = cartItems.reduce((sum, item) => sum + (item.products.price * item.quantity), 0);
                
                resultDiv.innerHTML = `
                    <div class="text-green-600 mb-4">
                        <i class="fas fa-check mr-2"></i>
                        Cart loaded successfully - ${totalItems} items, $${totalValue.toFixed(2)} total
                    </div>
                    <div class="space-y-2">
                        ${cartItems.map(item => `
                            <div class="flex justify-between items-center border-b pb-2">
                                <span>${item.products.name} (x${item.quantity})</span>
                                <span>$${(item.products.price * item.quantity).toFixed(2)}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
                
            } catch (error) {
                console.error('Get cart error:', error);
                resultDiv.innerHTML = `
                    <div class="text-red-600">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        Error loading cart: ${error.message}
                    </div>
                `;
            }
        }

        async function testClearCart() {
            const resultDiv = document.getElementById('cart-result');
            resultDiv.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Clearing cart...';
            
            try {
                await cartAPI.clearCart();
                
                resultDiv.innerHTML = `
                    <div class="text-green-600">
                        <i class="fas fa-check mr-2"></i>
                        Cart cleared successfully!
                    </div>
                `;
                
            } catch (error) {
                console.error('Clear cart error:', error);
                resultDiv.innerHTML = `
                    <div class="text-red-600">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        Error clearing cart: ${error.message}
                    </div>
                `;
            }
        }

        async function testCreateOrder() {
            const resultDiv = document.getElementById('order-result');
            resultDiv.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Creating test order...';
            
            try {
                // First, add an item to cart if empty
                const cartItems = await cartAPI.getItems();
                if (cartItems.length === 0) {
                    const products = await productsAPI.getAll();
                    if (products.length > 0) {
                        await cartAPI.addItem(products[0].id, 1);
                    } else {
                        throw new Error('No products available to create order');
                    }
                }
                
                // Create test order
                const orderData = {
                    shippingAddress: {
                        firstName: 'John',
                        lastName: 'Doe',
                        email: 'john.doe@example.com',
                        address: '123 Test Street',
                        city: 'Test City',
                        state: 'TS',
                        zip: '12345'
                    },
                    billingAddress: {
                        firstName: 'John',
                        lastName: 'Doe',
                        email: 'john.doe@example.com',
                        address: '123 Test Street',
                        city: 'Test City',
                        state: 'TS',
                        zip: '12345'
                    }
                };
                
                const order = await ordersAPI.createOrder(orderData);
                
                resultDiv.innerHTML = `
                    <div class="text-green-600 mb-4">
                        <i class="fas fa-check mr-2"></i>
                        Order created successfully!
                    </div>
                    <div class="bg-white border rounded-lg p-4">
                        <p><strong>Order ID:</strong> ${order.id}</p>
                        <p><strong>Total:</strong> $${order.total_amount.toFixed(2)}</p>
                        <p><strong>Status:</strong> ${order.status}</p>
                        <p><strong>Created:</strong> ${new Date(order.created_at).toLocaleString()}</p>
                    </div>
                `;
                
            } catch (error) {
                console.error('Create order error:', error);
                resultDiv.innerHTML = `
                    <div class="text-red-600">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        Error creating order: ${error.message}
                    </div>
                `;
            }
        }

        // Make functions available globally
        window.testProducts = testProducts;
        window.testAddToCart = testAddToCart;
        window.testGetCart = testGetCart;
        window.testClearCart = testClearCart;
        window.testCreateOrder = testCreateOrder;
    </script>
</body>
</html>
